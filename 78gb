local Notification = loadstring(game:HttpGet("https://raw.githubusercontent.com/Qing-Yun-Dev/UI/Main/Notification.lua"))()

function Notify(Text)
    Notification:ForceNotify({Name = "by:codm656558 | Guts & Blackpower", Text = Text, Icon = "rbxassetid://11401835376", Duration = 5})
end

if game:GetService("UserInputService").KeyboardEnabled and game:GetService("UserInputService").MouseEnabled then
    Notify("F5 Hide UI")
elseif game:GetService("UserInputService").TouchEnabled then
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Qing-Yun-Dev/UI/Main/Open.lua"))()
end

local UI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Qing-Yun-Dev/UI/Main/Vape.lua"))()

local Win = UI:Window("codm656558 | Guts & Blackpower | 不用拉倒去买别人的 | 注入器 : "..identifyexecutor(), Color3.fromRGB(44, 120, 224))

local Tab = Win:Tab("Main")

-- 辅助函数：获取玩家当前武器
local function GetGun()
    local character = game.Players.LocalPlayer.Character
    if character then
        for _, child in pairs(character:GetChildren()) do
            if child:GetAttribute("IsGun") then
                return child
            end
        end
    end
    local backpack = game.Players.LocalPlayer.Backpack
    if backpack then
        for _, child in pairs(backpack:GetChildren()) do
            if child:GetAttribute("IsGun") then
                return child
            end
        end
    end
    return nil
end

-- 墙体检测函数（优化版）
local wallCheckEnabled = false
local Player = game.Players.LocalPlayer

local function isBehindWall(targetPart, origin)
    if not wallCheckEnabled then return false end
    
    -- 排除Buildings文件夹内的建筑
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    local filterList = {Player.Character, targetPart.Parent}
    
    -- 添加Buildings文件夹到黑名单，使其可穿透
    local buildingsFolder = workspace:FindFirstChild("Buildings")
    if buildingsFolder then
        for _, building in ipairs(buildingsFolder:GetDescendants()) do
            if building:IsA("BasePart") then
                table.insert(filterList, building)
            end
        end
    end
    
    raycastParams.FilterDescendantsInstances = filterList
    
    local direction = (targetPart.Position - origin).Unit
    local distance = (targetPart.Position - origin).Magnitude
    local raycastResult = workspace:Raycast(origin, direction * distance, raycastParams)
    
    return raycastResult ~= nil
end

-- 自动射击Barrel功能（优化版，修复卡顿）
local AutoShootBarrel = false
local AutoShootBarrelThread = nil
local BarrelShootDistance = 10 -- 其他玩家靠近Barrel的距离
local WallCheck = false -- 墙体检测开关
local RangeCircle = false -- 范围圈开关
local RangeCircleRadius = 10 -- 范围圈半径
local RangeCirclePart = nil -- 范围圈可视化部分
local AutoShootFrequency = 0.8 -- 自动射击检测频率，默认0.8秒

-- 创建范围圈可视化（圆形）
local function CreateRangeCircle()
    if RangeCirclePart then
        RangeCirclePart:Destroy()
    end
    
    RangeCirclePart = Instance.new("Part")
    RangeCirclePart.Shape = Enum.PartType.Cylinder
    RangeCirclePart.Size = Vector3.new(0.1, RangeCircleRadius * 2, RangeCircleRadius * 2)
    RangeCirclePart.Transparency = 0.7
    RangeCirclePart.Color = Color3.fromRGB(0, 255, 0)
    RangeCirclePart.Material = Enum.Material.Neon
    RangeCirclePart.Anchored = true
    RangeCirclePart.CanCollide = false
    RangeCirclePart.Parent = workspace
end

-- 更新范围圈位置
local function UpdateRangeCircle()
    if RangeCircle and RangeCirclePart then
        local character = game.Players.LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            RangeCirclePart.Position = character.HumanoidRootPart.Position
            RangeCirclePart.CFrame = CFrame.new(character.HumanoidRootPart.Position) * CFrame.Angles(0, 0, math.rad(90))
        end
    end
end

-- 检查是否有其他玩家靠近Barrel（优化版，使用可调节频率）
local function CheckBarrelsForAutoShoot()
    if not AutoShootBarrel then return nil end
    
    local gun = GetGun()
    if not gun or gun.ShotsLoaded.Value <= 0 then return nil end
    
    local foundBarrel = nil
    local closestDistance = math.huge
    
    -- 查找所有Barrel
    for _, barrel in ipairs(workspace:GetDescendants()) do
        if barrel.Name == "Agent" and barrel:GetAttribute("Type") == "Barrel" and barrel:FindFirstChild("HumanoidRootPart") then
            -- 检查是否有其他玩家靠近
            for _, player in ipairs(game.Players:GetPlayers()) do
                if player ~= game.Players.LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") then
                    local humanoid = player.Character.Humanoid
                    if humanoid.Health > 0 and player.Character:FindFirstChild("HumanoidRootPart") then
                        local distance = (player.Character.HumanoidRootPart.Position - barrel.HumanoidRootPart.Position).Magnitude
                        
                        -- 检查是否在范围内
                        if distance <= BarrelShootDistance then
                            -- 检查是否在范围圈内（如果开启了范围圈）
                            if RangeCircle then
                                local myPos = game.Players.LocalPlayer.Character.HumanoidRootPart.Position
                                local barrelPos = barrel.HumanoidRootPart.Position
                                local distanceToBarrel = (myPos - barrelPos).Magnitude
                                
                                if distanceToBarrel <= RangeCircleRadius then
                                    -- 墙体检测（如果开启）
                                    if WallCheck then
                                        local origin = Player.Character.Head.Position
                                        if not isBehindWall(barrel.HumanoidRootPart, origin) then
                                            if distance < closestDistance then
                                                closestDistance = distance
                                                foundBarrel = barrel
                                            end
                                        end
                                    else
                                        if distance < closestDistance then
                                            closestDistance = distance
                                            foundBarrel = barrel
                                        end
                                    end
                                end
                            else
                                -- 墙体检测（如果开启）
                                if WallCheck then
                                    local origin = Player.Character.Head.Position
                                    if not isBehindWall(barrel.HumanoidRootPart, origin) then
                                        if distance < closestDistance then
                                            closestDistance = distance
                                            foundBarrel = barrel
                                        end
                                    end
                                else
                                    if distance < closestDistance then
                                        closestDistance = distance
                                        foundBarrel = barrel
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    
    return foundBarrel
end

-- 自动射击方案：情云方案
local AutoShootMode = 1 -- 只保留情云方案
local AutoShootToggle

-- 创建自动射击Toggle
local function CreateAutoShootToggle()
    AutoShootToggle = Tab:Toggle("自动黑枪", false, function(Value)
        if Value then
            AutoShootMode = 1
            Notify("启用自动黑枪")
        end
    end)
end

-- 初始化自动射击Toggle
CreateAutoShootToggle()

-- 启动自动射击（优化版，修复卡顿）
Tab:Toggle("启用自动黑枪(没自爆地方建议关闭)", false, function(Value)
    AutoShootBarrel = Value
    
    if Value then
        Notify("自动黑枪已启用")
        
        -- 创建范围圈（如果需要）
        if RangeCircle then
            CreateRangeCircle()
        end
        
        -- 启动自动射击线程（使用可调节频率）
        AutoShootBarrelThread = task.spawn(function()
            while AutoShootBarrel do
                -- 使用可调节频率
                task.wait(AutoShootFrequency)
                
                -- 更新范围圈位置
                if RangeCircle then
                    UpdateRangeCircle()
                end
                
                -- 检测是否有符合条件的Barrel
                local barrel = CheckBarrelsForAutoShoot()
                if barrel then
                    -- 执行射击（只射击一次）
                    local gun = GetGun()
                    if gun and gun.ShotsLoaded.Value > 0 then
                        local Velocity = barrel.HumanoidRootPart.Velocity
                        local Magnitude = Velocity.Magnitude * 0.3
                        
                        if Magnitude > 0 then
                            gun.RemoteEvent:FireServer("Fire", game.Players.LocalPlayer.Character.Model, 
                                barrel.HumanoidRootPart.Position + Velocity.Unit * Magnitude, workspace:GetServerTimeNow())
                        else
                            gun.RemoteEvent:FireServer("Fire", game.Players.LocalPlayer.Character.Model, 
                                barrel.HumanoidRootPart.Position, workspace:GetServerTimeNow())
                        end
                        
                        -- 如果射击成功且子弹为0，自动换弹
                        if gun.ShotsLoaded.Value == 0 then
                            task.wait(0.1)
                            gun.RemoteEvent:FireServer("Reload")
                        end
                    end
                end
            end
        end)
    else
        -- 停止自动射击线程
        if AutoShootBarrelThread then
            task.cancel(AutoShootBarrelThread)
            AutoShootBarrelThread = nil
        end
        
        -- 清理范围圈
        if RangeCirclePart then
            RangeCirclePart:Destroy()
            RangeCirclePart = nil
        end
        
        Notify("自动黑枪已禁用")
    end
end)

-- 自动射击检测频率调节
Tab:Slider("自动黑枪检测频率(配置不好拉一半就可秒爆)", 0.1, 1, 0.8, function(Value)
    AutoShootFrequency = Value
    Notify("自动黑枪检测频率设置为: " .. string.format("%.1f", Value) .. " 秒")
end)

-- 添加距离滑动模块
Tab:Slider("队友靠近Barrel距离(显示距离除3就是实际距离)", 1, 50, 10, function(Value)
    BarrelShootDistance = Value
    Notify("队友靠近Barrel距离设置为: " .. Value .. " studs")
end)

-- 范围圈大小调节
Tab:Slider("范围圈大小(同样除3)", 5, 150, 10, function(Value)
    RangeCircleRadius = Value
    Notify("范围圈大小设置为: " .. Value .. " studs")
    
    -- 更新范围圈大小
    if RangeCirclePart then
        RangeCirclePart.Size = Vector3.new(0.1, RangeCircleRadius * 2, RangeCircleRadius * 2)
    end
end)

-- 墙体检测开关
Tab:Toggle("墙体检测", false, function(Value)
    WallCheck = Value
    wallCheckEnabled = Value
    Notify("墙体检测(开了用不了自动黑枪): " .. (Value and "开启" or "关闭"))
end)

-- 范围圈开关
Tab:Toggle("范围圈显示", false, function(Value)
    RangeCircle = Value
    if Value then
        CreateRangeCircle()
        Notify("范围圈已显示")
    else
        if RangeCirclePart then
            RangeCirclePart:Destroy()
            RangeCirclePart = nil
        end
        Notify("范围圈已隐藏")
    end
end)

-- 自动换弹方案2
local AutoReloadV2Enabled = false
local AutoReloadV2Connection = nil

Tab:Toggle("自动换弹", false, function(Value)
    AutoReloadV2Enabled = Value
    if Value then
        AutoReloadV2Connection = game:GetService("RunService").RenderStepped:Connect(function()
            if not AutoReloadV2Enabled then return end
            
            local gun = GetGun()
            if gun then
                gun.RemoteEvent:FireServer("Reload")
            end
        end)
        Notify("启用自动换弹")
    else
        if AutoReloadV2Connection then
            AutoReloadV2Connection:Disconnect()
            AutoReloadV2Connection = nil
        end
        Notify("禁用自动换弹")
    end
end)

Tab:Toggle("Silent Aim", false, function(Value)
    if Value then
        OriginalNamecall = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
            local args = {...}
            if args[1] == "Fire" then
                task.spawn(function()
                    for _, v in ipairs(workspace:GetDescendants()) do
                        if v.Name == "HeadlessHorseman" or v.Name == "Dracula" or (v.Name == "Agent" and v:GetAttribute("Type") == "Barrel") then
                            local TargetVelocity = v.HumanoidRootPart.Velocity
                            local Distance = TargetVelocity.Magnitude * 0.3
                            if Distance > 0 then
                                local Direction = TargetVelocity.Unit
                                local PredictedPosition = v.HumanoidRootPart.Position + (Direction * Distance)
                                args[3] = PredictedPosition
                            else
                                args[3] = v.HumanoidRootPart.Position
                            end
                            return OriginalNamecall(self, unpack(args))
                        end
                    end
                end)
            end
            return OriginalNamecall(self, unpack(args))
        end))
    else
        if OriginalNamecall then
            hookmetamethod(game, "__namecall", OriginalNamecall)
        end
    end
end)

local Tab = Win:Tab("ESP")

local function ESP(inst, color, size, text, Highlight)
    if Highlight then
        local Highlight = Instance.new("Highlight")
        Highlight.Parent = inst
        Highlight.FillColor = color
        Highlight.FillTransparency = 0.50
        Highlight.Name = "QYHighlight"
        game:GetService("TweenService"):Create(
            Highlight,
            TweenInfo.new(1),
            {
                OutlineTransparency = Highlight.OutlineTransparency
            }
        ):Play()
    end

    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Parent = inst
    BillboardGui.Size = size
    BillboardGui.StudsOffset = Vector3.new(0, 1, 0)
    BillboardGui.Name = "QY"

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = text
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.FontSize = Enum.FontSize.Size24
    TextLabel.TextColor3 = color
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = size
    TextLabel.Parent = BillboardGui
    TextLabel.Name = "QY"
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextStrokeColor3 = Color3.new(1, 1, 1)

    return Highlight, BillboardGui
end

-- 独立透视功能变量
local visionConnections = {}
local zombieHighlights = {}
local draculaHighlight = nil
local headlessHorsemanHighlight = nil

-- 僵尸类型配置（独立开关）
local ZOMBIE_TYPES = {
    ["Axe"] = {
        name = "Za",
        color = Color3.fromRGB(180, 0, 250), -- 紫色
        enabled = false,
        highlightColor = Color3.fromRGB(180, 0, 250)
    },
    ["Eye"] = {
        name = "Ru", 
        color = Color3.fromRGB(255, 50, 50), -- 红色
        enabled = false,
        highlightColor = Color3.fromRGB(255, 50, 50)
    },
    ["Sword"] = {
        name = "Cu",
        color = Color3.fromRGB(456,13,56), -- 深红色
        enabled = false,
        highlightColor = Color3.fromRGB(456,13,56)
    },
    ["Barrel"] = {
        name = "Ba",
        color = Color3.fromRGB(250, 250, 0), -- 黄色
        enabled = false,
        highlightColor = Color3.fromRGB(250, 250, 0)
    },
    ["FTorso"] = {
        name = "Li",
        color = Color3.fromRGB(255, 120, 0), -- 橙色
        enabled = false,
        highlightColor = Color3.fromRGB(255, 120, 0)
    }
}

-- 德古拉配置
local DRACULA_CONFIG = {
    name = "德古拉",
    color = Color3.fromRGB(43, 255, 0), -- 绿色
    enabled = false,
    highlightColor = Color3.fromRGB(43, 255, 0)
}

-- 无头骑士配置  
local HEADLESS_HORSEMAN_CONFIG = {
    name = "无头骑士",
    color = Color3.fromRGB(255, 0, 0), -- 红色
    enabled = false,
    highlightColor = Color3.fromRGB(255, 0, 0)
}

-- 查找僵尸
local function findZombies()
    local zombies = {}
    local cameraFolder = workspace:FindFirstChild("Camera")
    
    if cameraFolder then
        for _, model in pairs(cameraFolder:GetChildren()) do
            if model:IsA("Model") and model.Name:find("Zombie") then
                table.insert(zombies, model)
            end
        end
    end
    
    return zombies
end

local function findDracula()
    local transylvania = workspace:FindFirstChild("Transylvania")
    if not transylvania then return nil end
    
    local modes = transylvania:FindFirstChild("Modes")
    if not modes then return nil end
    
    local boss = modes:FindFirstChild("Boss")
    if not boss then return nil end
    
    return boss:FindFirstChild("Dracula")
end

local function findHeadlessHorseman()
    for _, model in pairs(workspace:GetChildren()) do
        if model:IsA("Model") and model.Name == "HeadlessHorseman" then
            return model
        end
    end
    return nil
end

-- 检查僵尸是否匹配开启的透视类型
local function shouldHighlightZombie(zombie)
    for partName, config in pairs(ZOMBIE_TYPES) do
        if config.enabled and zombie:FindFirstChild(partName) then
            return config
        end
    end
    return nil
end

-- 创建僵尸高亮
local function createZombieHighlight(zombie, zombieConfig)
    if zombieHighlights[zombie] then
        return -- 已经存在高亮，不重复创建
    end
    
    local attachPart = zombie.PrimaryPart or zombie:FindFirstChild("Head") or zombie:FindFirstChild("HumanoidRootPart")
    if not attachPart then return end
    
    -- 创建高亮（情云风格）
    local highlight = Instance.new("Highlight")
    highlight.Name = "QYHighlight"
    highlight.FillColor = zombieConfig.highlightColor
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Parent = attachPart
    
    -- 创建BillboardGui（情云风格，更小的尺寸）
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Parent = attachPart
    BillboardGui.Size = UDim2.new(0, 80, 0, 30) -- 更小的尺寸
    BillboardGui.StudsOffset = Vector3.new(0, 2, 0)
    BillboardGui.Name = "QY"

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = zombieConfig.name
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.FontSize = Enum.FontSize.Size18 -- 更小的字体
    TextLabel.TextColor3 = zombieConfig.highlightColor
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.Parent = BillboardGui
    TextLabel.Name = "QY"
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextStrokeColor3 = Color3.new(1, 1, 1)
    
    zombieHighlights[zombie] = {highlight = highlight, billboard = BillboardGui}
end

-- 创建德古拉高亮
local function createDraculaHighlight(dracula)
    if draculaHighlight then
        return -- 已经存在，不重复创建
    end
    
    local attachPart = dracula.PrimaryPart or dracula:FindFirstChild("Head") or dracula:FindFirstChild("HumanoidRootPart")
    if not attachPart then return end
    
    -- 创建高亮（情云风格）
    local highlight = Instance.new("Highlight")
    highlight.Name = "QYHighlight"
    highlight.FillColor = DRACULA_CONFIG.highlightColor
    highlight.FillTransparency = 0.4
    highlight.OutlineTransparency = 0
    highlight.Parent = attachPart
    
    -- 创建BillboardGui（情云风格，更小的尺寸）
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Parent = attachPart
    BillboardGui.Size = UDim2.new(0, 100, 0, 35) -- 更小的尺寸
    BillboardGui.StudsOffset = Vector3.new(0, 2.5, 0)
    BillboardGui.Name = "QY"

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = DRACULA_CONFIG.name
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.FontSize = Enum.FontSize.Size20 -- 更小的字体
    TextLabel.TextColor3 = DRACULA_CONFIG.highlightColor
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.Parent = BillboardGui
    TextLabel.Name = "QY"
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextStrokeColor3 = Color3.new(1, 1, 1)
    
    draculaHighlight = {highlight = highlight, billboard = BillboardGui}
end

-- 创建无头骑士高亮
local function createHeadlessHorsemanHighlight(horseman)
    if headlessHorsemanHighlight then
        return -- 已经存在，不重复创建
    end
    
    local attachPart = horseman.PrimaryPart or horseman:FindFirstChild("HumanoidRootPart")
    if not attachPart then return end
    
    -- 创建高亮（情云风格）
    local highlight = Instance.new("Highlight")
    highlight.Name = "QYHighlight"
    highlight.FillColor = HEADLESS_HORSEMAN_CONFIG.highlightColor
    highlight.FillTransparency = 0.4
    highlight.OutlineTransparency = 0
    highlight.Parent = attachPart
    
    -- 创建BillboardGui（情云风格，更小的尺寸）
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Parent = attachPart
    BillboardGui.Size = UDim2.new(0, 90, 0, 30) -- 更小的尺寸
    BillboardGui.StudsOffset = Vector3.new(0, 2.5, 0)
    BillboardGui.Name = "QY"

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Text = HEADLESS_HORSEMAN_CONFIG.name
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.FontSize = Enum.FontSize.Size18 -- 更小的字体
    TextLabel.TextColor3 = HEADLESS_HORSEMAN_CONFIG.highlightColor
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 1, 0)
    TextLabel.Parent = BillboardGui
    TextLabel.Name = "QY"
    TextLabel.TextStrokeTransparency = 0
    TextLabel.TextStrokeColor3 = Color3.new(1, 1, 1)
    
    headlessHorsemanHighlight = {highlight = highlight, billboard = BillboardGui}
end

-- 清理僵尸高亮
local function clearZombieHighlights()
    for zombie, highlightData in pairs(zombieHighlights) do
        if highlightData.highlight and highlightData.highlight.Parent then
            highlightData.highlight:Destroy()
        end
        if highlightData.billboard and highlightData.billboard.Parent then
            highlightData.billboard:Destroy()
        end
    end
    zombieHighlights = {}
    
    if draculaHighlight then
        if draculaHighlight.highlight then draculaHighlight.highlight:Destroy() end
        if draculaHighlight.billboard then draculaHighlight.billboard:Destroy() end
        draculaHighlight = nil
    end
    
    if headlessHorsemanHighlight then
        if headlessHorsemanHighlight.highlight then headlessHorsemanHighlight.highlight:Destroy() end
        if headlessHorsemanHighlight.billboard then headlessHorsemanHighlight.billboard:Destroy() end
        headlessHorsemanHighlight = nil
    end
end

-- 更新僵尸高亮
local function updateZombieHighlights()
    -- 清理不存在的僵尸高亮
    local toRemove = {}
    for zombie, _ in pairs(zombieHighlights) do
        if not zombie.Parent then
            toRemove[zombie] = true
        end
    end
    for zombie in pairs(toRemove) do
        if zombieHighlights[zombie] then
            if zombieHighlights[zombie].highlight then zombieHighlights[zombie].highlight:Destroy() end
            if zombieHighlights[zombie].billboard then zombieHighlights[zombie].billboard:Destroy() end
        end
        zombieHighlights[zombie] = nil
    end
    
    -- 更新普通僵尸高亮
    local zombies = findZombies()
    for _, zombie in pairs(zombies) do
        local zombieConfig = shouldHighlightZombie(zombie)
        if zombieConfig then
            if not zombieHighlights[zombie] then
                createZombieHighlight(zombie, zombieConfig)
            end
        else
            -- 如果僵尸不应该被高亮，但之前有高亮，则清除
            if zombieHighlights[zombie] then
                if zombieHighlights[zombie].highlight then zombieHighlights[zombie].highlight:Destroy() end
                if zombieHighlights[zombie].billboard then zombieHighlights[zombie].billboard:Destroy() end
                zombieHighlights[zombie] = nil
            end
        end
    end
    
    -- 更新德古拉高亮
    if DRACULA_CONFIG.enabled then
        local dracula = findDracula()
        if dracula then
            if not draculaHighlight then
                createDraculaHighlight(dracula)
            end
        else
            if draculaHighlight then
                if draculaHighlight.highlight then draculaHighlight.highlight:Destroy() end
                if draculaHighlight.billboard then draculaHighlight.billboard:Destroy() end
                draculaHighlight = nil
            end
        end
    else
        if draculaHighlight then
            if draculaHighlight.highlight then draculaHighlight.highlight:Destroy() end
            if draculaHighlight.billboard then draculaHighlight.billboard:Destroy() end
            draculaHighlight = nil
        end
    end
    
    -- 更新无头骑士高亮
    if HEADLESS_HORSEMAN_CONFIG.enabled then
        local headlessHorseman = findHeadlessHorseman()
        if headlessHorseman then
            if not headlessHorsemanHighlight then
                createHeadlessHorsemanHighlight(headlessHorseman)
            end
        else
            if headlessHorsemanHighlight then
                if headlessHorsemanHighlight.highlight then headlessHorsemanHighlight.highlight:Destroy() end
                if headlessHorsemanHighlight.billboard then headlessHorsemanHighlight.billboard:Destroy() end
                headlessHorsemanHighlight = nil
            end
        end
    else
        if headlessHorsemanHighlight then
            if headlessHorsemanHighlight.highlight then headlessHorsemanHighlight.highlight:Destroy() end
            if headlessHorsemanHighlight.billboard then headlessHorsemanHighlight.billboard:Destroy() end
            headlessHorsemanHighlight = nil
        end
    end
end

-- 启用透视功能
local function enableVision(zombieType)
    if visionConnections[zombieType] then return end
    
    -- 启动更新循环
    visionConnections[zombieType] = game:GetService("RunService").Heartbeat:Connect(function()
        -- 检查是否还有任何僵尸类型被启用
        local anyEnabled = false
        for _, config in pairs(ZOMBIE_TYPES) do
            if config.enabled then
                anyEnabled = true
                break
            end
        end
        
        if DRACULA_CONFIG.enabled or HEADLESS_HORSEMAN_CONFIG.enabled then
            anyEnabled = true
        end
        
        if not anyEnabled then
            -- 如果没有类型被启用，断开所有连接
            for typeName, connection in pairs(visionConnections) do
                connection:Disconnect()
                visionConnections[typeName] = nil
            end
            clearZombieHighlights()
            return
        end
        
        updateZombieHighlights()
    end)
    
    -- 初始更新
    updateZombieHighlights()
end

-- 禁用透视功能
local function disableVision(zombieType)
    if visionConnections[zombieType] then
        visionConnections[zombieType]:Disconnect()
        visionConnections[zombieType] = nil
    end
    
    -- 清理对应类型的高亮
    for zombie, highlightData in pairs(zombieHighlights) do
        local zombieConfig = shouldHighlightZombie(zombie)
        if not zombieConfig then
            if highlightData.highlight then highlightData.highlight:Destroy() end
            if highlightData.billboard then highlightData.billboard:Destroy() end
            zombieHighlights[zombie] = nil
        end
    end
    
    -- 如果没有类型被启用，断开所有连接
    local anyEnabled = false
    for _, config in pairs(ZOMBIE_TYPES) do
        if config.enabled then
            anyEnabled = true
            break
        end
    end
    
    if DRACULA_CONFIG.enabled or HEADLESS_HORSEMAN_CONFIG.enabled then
        anyEnabled = true
    end
    
    if not anyEnabled then
        for typeName, connection in pairs(visionConnections) do
            connection:Disconnect()
            visionConnections[typeName] = nil
        end
        clearZombieHighlights()
    end
end

-- 原ESP功能
Tab:Toggle("Bomber ESP", false, function(Value)
    if Value then
        BomberESP = workspace.Zombies.DescendantAdded:Connect(function(inst)
            if inst.Name == "Agent" and inst:GetAttribute("Type") == "Barrel" then
                local BillboardGui = ESP(inst, Color3.new(1, 0, 0), UDim2.new(0, 80, 0, 30), "Bomber") -- 改小尺寸
            end
        end)
        for _, v in ipairs(workspace.Zombies:GetDescendants()) do
            if v.Name == "Agent" and v:GetAttribute("Type") == "Barrel" then
                local BillboardGui = ESP(v, Color3.new(1, 0, 0), UDim2.new(0, 80, 0, 30), "Bomber") -- 改小尺寸
            end
        end
    else
        if BomberESP then
            BomberESP:Disconnect()
        end
        for _, v in ipairs(workspace.Zombies:GetDescendants()) do
            if v.Name == "Agent" and v:GetAttribute("Type") == "Barrel" then
                if v:FindFirstChild("QY") then
                    v.QY:Destroy()
                end
            end
        end
    end
end)

-- 独立僵尸透视开关
Tab:Toggle("大师兄透视", false, function(Value)
    ZOMBIE_TYPES["Axe"].enabled = Value
    Notify("大师兄透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("Axe")
    else
        disableVision("Axe")
    end
end)

Tab:Toggle("红眼透视", false, function(Value)
    ZOMBIE_TYPES["Eye"].enabled = Value
    Notify("红眼透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("Eye")
    else
        disableVision("Eye")
    end
end)

Tab:Toggle("胸甲僵尸透视", false, function(Value)
    ZOMBIE_TYPES["Sword"].enabled = Value
    Notify("胸甲僵尸透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("Sword")
    else
        disableVision("Sword")
    end
end)

Tab:Toggle("自爆透视", false, function(Value)
    ZOMBIE_TYPES["Barrel"].enabled = Value
    Notify("自爆透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("Barrel")
    else
        disableVision("Barrel")
    end
end)

Tab:Toggle("火哥透视", false, function(Value)
    ZOMBIE_TYPES["FTorso"].enabled = Value
    Notify("火哥透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("FTorso")
    else
        disableVision("FTorso")
    end
end)

Tab:Toggle("德古拉透视", false, function(Value)
    DRACULA_CONFIG.enabled = Value
    Notify("德古拉透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("Dracula")
    else
        disableVision("Dracula")
    end
end)

Tab:Toggle("无头骑士透视", false, function(Value)
    HEADLESS_HORSEMAN_CONFIG.enabled = Value
    Notify("无头骑士透视: " .. (Value and "开启" or "关闭"))
    
    if Value then
        enableVision("HeadlessHorseman")
    else
        disableVision("HeadlessHorseman")
    end
end)

-- 大头娃娃功能
local bigHeadEnabled = false
local bigHeadConnection = nil
local originalProperties = {}

local function processBigHead()
    local camera = workspace:FindFirstChild("Camera")
    if not camera then return end
    
    for _, zombie in ipairs(camera:GetDescendants()) do
        if zombie.Name == "m_Zombie" and zombie:FindFirstChild("Head") then
            local head = zombie.Head
            if bigHeadEnabled then
                if not originalProperties[zombie] then
                    originalProperties[zombie] = {
                        Size = head.Size,
                        Transparency = head.Transparency
                    }
                end
                head.Size = Vector3.new(4, 4, 4)
                head.Transparency = 0.5
            else
                if originalProperties[zombie] then
                    head.Size = originalProperties[zombie].Size
                    head.Transparency = originalProperties[zombie].Transparency
                end
            end
        end
    end
end

Tab:Toggle("大头僵尸", false, function(Value)
    bigHeadEnabled = Value
    Notify("大头僵尸: " .. (Value and "开启" or "关闭"))
    
    if Value then
        -- 开启大头娃娃
        processBigHead()
        bigHeadConnection = workspace.Camera.DescendantAdded:Connect(function(descendant)
            if descendant.Name == "m_Zombie" and descendant:FindFirstChild("Head") then
                if bigHeadEnabled then
                    task.wait(0.1)
                    local head = descendant.Head
                    originalProperties[descendant] = {
                        Size = head.Size,
                        Transparency = head.Transparency
                    }
                    head.Size = Vector3.new(4, 4, 4)
                    head.Transparency = 0.5
                end
            end
        end)
    else
        -- 关闭大头娃娃
        processBigHead()
        table.clear(originalProperties)
        
        if bigHeadConnection then
            bigHeadConnection:Disconnect()
            bigHeadConnection = nil
        end
    end
end)

-- 移除摔伤功能
local noFallDamageEnabled = false
local fallDamageConnection = nil

local function preventFallDamage()
    while noFallDamageEnabled do
        task.wait(2) -- 降低检测频率
        if not game.Players.LocalPlayer.Character then continue end
        
        local health = game.Players.LocalPlayer.Character:FindFirstChild("Health")
        if not health then continue end
        
        local forceSelfDamage = health:FindFirstChild("ForceSelfDamage")
        if not forceSelfDamage then continue end
        
        local args = {0}
        pcall(function()
            forceSelfDamage:FireServer(unpack(args))
        end)
    end
end

Tab:Toggle("移除摔伤", false, function(Value)
    noFallDamageEnabled = Value
    Notify("移除摔伤: " .. (Value and "开启" or "关闭"))
    
    if Value then
        -- 开启移除摔伤
        fallDamageConnection = task.spawn(preventFallDamage)
    else
        -- 关闭移除摔伤
        if fallDamageConnection then
            task.cancel(fallDamageConnection)
            fallDamageConnection = nil
        end
    end
end)

local Tab = Win:Tab("Player")

local Speed = 0
local JumpPower = 30

Tab:Toggle("Infinite Jump", false, function(Value)
    if Value then
        InfiniteJump = game:GetService("UserInputService").JumpRequest:Connect(function()
            game.Players.LocalPlayer.Character.Humanoid:ChangeState("Jumping")
        end)
    else
        if InfiniteJump then
            InfiniteJump:Disconnect()
        end
    end
end)

Tab:Toggle("Enable Speed", false, function(Value)
    if Value then
        EnableSpeed = game:GetService("RunService").Heartbeat:Connect(function()
            if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("Humanoid") then
                game.Players.LocalPlayer.Character:TranslateBy(game.Players.LocalPlayer.Character.Humanoid.MoveDirection * Speed / 10)
            end
        end)
    else
        if EnableSpeed then
            EnableSpeed:Disconnect()
        end
    end
end)

Tab:Toggle("Enable Jump", false, function(Value)
    if Value then
        EnableJump = game:GetService("RunService").RenderStepped:Connect(function()
            if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("Humanoid") then
                game.Players.LocalPlayer.Character.Humanoid.JumpPower = JumpPower or 30
            end
        end)
    else
        if EnableJump then
            EnableJump:Disconnect()
        end
        if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("Humanoid") then
            game.Players.LocalPlayer.Character.Humanoid.JumpPower = 30
        end
    end
end)

Tab:Slider("Speed", 0, 10, 0, function(Value)
    Speed = Value
end)

Tab:Slider("Jump Power", 30, 100, 0, function(Value)
    JumpPower = Value
end)

local Tab = Win:Tab("Misc")

Tab:Button("Close UI", function()
    game.CoreGui.VisionLibV2:Destroy()
    game.CoreGui.VisionLibOverlay:Destroy()
    if game:GetService("UserInputService").KeyboardEnabled and game:GetService("UserInputService").MouseEnabled then
        game.CoreGui.Vape:Destroy()
    elseif game:GetService("UserInputService").TouchEnabled then
        game.CoreGui.Open:Destroy()
        game.CoreGui.Vape:Destroy()
    end
end)
